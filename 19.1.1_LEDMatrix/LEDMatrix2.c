/**********************************************************************
* Filename    : LEDMatrix.c
* Description : Control LEDMatrix by 74HC595
* Author      : freenove
* modification: 2018/08/03
**********************************************************************/

#include <wiringPi.h>
#include <stdio.h>
#include <wiringShift.h>

#define dataPin   0   // DS Pin of 74HC595(Pin14)
#define latchPin  2   // ST_CP Pin of 74HC595(Pin12)
#define clockPin  3   // SH_CP Pin of 74HC595(Pin11)

// data of smiling face
unsigned char pic[] = { 0x1c, 0x22, 0x51, 0x45, 0x45, 0x51, 0x22, 0x1c };
//unsigned char pic[] = { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff };

unsigned char data[] = {  // data of "0-F"
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // " "
    0x00, 0x00, 0x3e, 0x61, 0x49, 0x43, 0x3e, 0x00, // "0"
    0x00, 0x00, 0x21, 0x7F, 0x01, 0x00, 0x00, 0x00, // "1"
    0x00, 0x00, 0x23, 0x45, 0x49, 0x31, 0x00, 0x00, // "2"
    0x00, 0x00, 0x22, 0x49, 0x49, 0x36, 0x00, 0x00, // "3"
    0x00, 0x00, 0x0E, 0x32, 0x7F, 0x02, 0x00, 0x00, // "4"
    0x00, 0x00, 0x79, 0x49, 0x49, 0x46, 0x00, 0x00, // "5"
    0x00, 0x00, 0x3E, 0x49, 0x49, 0x26, 0x00, 0x00, // "6"
    0x00, 0x00, 0x60, 0x47, 0x48, 0x70, 0x00, 0x00, // "7"
    0x00, 0x00, 0x36, 0x49, 0x49, 0x36, 0x00, 0x00, // "8"
    0x00, 0x00, 0x32, 0x49, 0x49, 0x3E, 0x00, 0x00, // "9"
    0x00, 0x00, 0x3F, 0x44, 0x44, 0x3F, 0x00, 0x00, // "A"
    0x00, 0x00, 0x7F, 0x49, 0x49, 0x36, 0x00, 0x00, // "B"
    0x00, 0x00, 0x3E, 0x41, 0x41, 0x22, 0x00, 0x00, // "C"
    0x00, 0x00, 0x7F, 0x41, 0x41, 0x3E, 0x00, 0x00, // "D"
    0x00, 0x00, 0x7F, 0x49, 0x49, 0x41, 0x00, 0x00, // "E"
    0x00, 0x00, 0x7F, 0x48, 0x48, 0x40, 0x00, 0x00, // "F"
    0x00, 0x00, 0x3e, 0x41, 0x45, 0x26, 0x00, 0x00, // "G"
    0x00, 0x00, 0x7f, 0x04, 0x04, 0x7f, 0x00, 0x00, // "H"
    0x00, 0x00, 0x41, 0x7f, 0x41, 0x00, 0x00, 0x00, // "I"
    0x00, 0x00, 0x00, 0x03, 0x41, 0x7f, 0x40, 0x00, // "J"
    0x00, 0x00, 0x7f, 0x04, 0x0a, 0x11, 0x00, 0x00, // "K'
    0x00, 0x00, 0x7f, 0x01, 0x01, 0x01, 0x00, 0x00, // "L"
    0x00, 0x00, 0x7f, 0x20, 0x18, 0x20, 0x7f, 0x00, // "M"
    0x00, 0x00, 0x7f, 0x10, 0x0c, 0x02, 0x7f, 0x00, // "N"
    0x00, 0x00, 0x3e, 0x41, 0x41, 0x41, 0x3e, 0x00, // "O"
    0x00, 0x00, 0x3f, 0x48, 0x48, 0x48, 0x30, 0x00, // "P"
    0x00, 0x00, 0x3e, 0x41, 0x45, 0x42, 0x3d, 0x00, // "Q"
    0x00, 0x00, 0x3f, 0x48, 0x4c, 0x4a, 0x31, 0x00, // "R"
    0x00, 0x00, 0x31, 0x51, 0x49, 0x46, 0x00, 0x00, // "S"

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // " "
};

void _shiftOut(int dPin, int cPin, int order, int val)
{
    int i;

    for (i = 0; i < 8; i++)
    {
      digitalWrite(cPin, LOW);
      if (order == LSBFIRST)
      {
        digitalWrite(dPin, ((0x01 & (val >> i)) == 0x01) ? HIGH : LOW);
        delayMicroseconds(10);
      }
      else
      { // order == MSBFIRST
        digitalWrite(dPin, ((0x80 & (val << i)) == 0x80) ? HIGH : LOW);
        delayMicroseconds(10);
      }
      digitalWrite(cPin, HIGH);
      delayMicroseconds(10);
    }
}

int main(void)
{
    int i;
    int j;
    int k;
    unsigned char x;

    if (wiringPiSetup() == -1)
    { // when initialize wiring failed, print message to screen
        printf("setup wiringPi failed!");
        return 1;
    }

    pinMode(dataPin, OUTPUT);
    pinMode(latchPin, OUTPUT);
    pinMode(clockPin, OUTPUT);

    while (1)
    {
      for (j = 0; j < 500; j++)
      { // Repeat enough times to display the smiling face a period of time
        x = 0x80;
        for (i = 0; i < 8; i++)
        {
          digitalWrite(latchPin, LOW);
          // first shift data of line information to the first stage 74HC595
          _shiftOut(dataPin, clockPin, MSBFIRST, pic[i]);
          // then shift data of column information to the second stage 74HC595
          _shiftOut(dataPin, clockPin, MSBFIRST, ~x);
          digitalWrite(latchPin, HIGH);  // Output data of two stage 74HC595 at the same time
          x >>= 1;                       // display the next column
          delay(1);
        }
      }
#if 1

      for (k = 0; k < (sizeof(data) - 8); k++)
      { // sizeof(data) total number of "0-F" columns
        for (j = 0; j < 20; j++)
        { // times of repeated displaying LEDMatrix in every frame, the bigger the “j”, the longer the display time
          x = 0x80;     // Set the column information to start from the first column
          for (i = k; i < (8 + k); i++)
          {
            digitalWrite(latchPin, LOW);
            _shiftOut(dataPin, clockPin, MSBFIRST, data[i]);
            _shiftOut(dataPin, clockPin, MSBFIRST, ~x);
            digitalWrite(latchPin, HIGH);
            x >>= 1;
            delay(1);
          }
        }
      }
#endif
    }
    return 0;
}
